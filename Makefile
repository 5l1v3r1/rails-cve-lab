_ROOT_DIR:=$(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
SHELL:=/bin/bash

export RUBY_VERSION?=2.5
export RAILS_VERSION?=5.0.0
export DATABASE?=sqlite3
export CVE?=CVE-2020-8163
export RAILS_APP?=${_ROOT_DIR}/cves/${CVE}
export COMPOSE_DOCKER_CLI_BUILD=1
export DOCKER_BUILDKIT=1

ifeq (bundle,$(firstword $(MAKECMDGOALS)))
  BUNDLE_ARGS := $(wordlist 2,$(words $(MAKECMDGOALS)),$(MAKECMDGOALS))
  $(eval $(BUNDLE_ARGS):;@:)
endif

.PHONY:
	bundle

default: help

help: #: Show help topics
	@grep "#:" Makefile* | grep -v "@grep" | sort | sed "s/\([A-Za-z_ -]*\):.*#\(.*\)/$$(tput setaf 3)\1$$(tput sgr0)\2/g"

down: #: Stop and remove containers, networks, images, and volumes
	-docker-compose down

up: #: Create and start containers
	docker-compose up

clean: down #: Clean up file system, containers, networks, images, and volumes
	[ -d "${RAILS_APP}" ] && rm -rf ${RAILS_APP} || echo "setting up new CVE"
	cp -R template ${RAILS_APP}
	@sed -i "s/gem 'rails', 'N.N.N'/gem 'rails', '${RAILS_VERSION}'/" ${RAILS_APP}/Gemfile
	@sed -i "s/CVE-NNNN-NNNN/${CVE}/" ${RAILS_APP}/docker-compose.yml
	docker-compose run web rails new . --force --skip-git --skip-bundle --no-deps --database=${DATABASE}
	@sed -i "s/gem 'rails', '~> 5.2.1'/gem 'rails', '${RAILS_VERSION}'/" ${RAILS_APP}/Gemfile
	@echo "gem 'brakeman'" >> ${RAILS_APP}/Gemfile
	@echo "gem 'bundle-audit'" >> ${RAILS_APP}/Gemfile
	@echo "gem 'ruby-debug-ide'" >> ${RAILS_APP}/Gemfile
	@echo "gem 'debase'" >> ${RAILS_APP}/Gemfile
	@echo "gem 'awesome_print'" >> ${RAILS_APP}/Gemfile

build: #: Build the target image
	docker-compose build \
	--build-arg RUBY_VERSION=${RUBY_VERSION} \
	--build-arg RAILS_VERSION=${RAILS_VERSION}

rebuild: #: Rebuild the target image with no cache
	docker-compose build --no-cache \
	--build-arg RUBY_VERSION=${RUBY_VERSION} \
	--build-arg RAILS_VERSION=${RAILS_VERSION}

bundle: #: bundle <ARGS>
	docker-compose run web bundle $(BUNDLE_ARGS)

server: up #: Run the rails server

debug: #: Run the debugger
	docker-compose -f docker-compose.yml -f docker-compose.debug.yml up

console: #: Run the rails console
	docker-compose exec web bundle exec rails console

shell: #: Run a bash shell
	docker-compose exec web bash

create: #: Run db:create
	docker-compose run web bundle exec rake db:create

migrate: #: Run db:migrate
	docker-compose run web bundle exec rake db:migrate

reset: #: Run db:reset
	docker-compose run web bundle exec rake db:reset

psql: #: Run a psql shell
	docker-compose run postgres psql -U postgres app_development

brakeman: #: Run brakeman tests
	docker-compose run web bundle exec brakeman --color --rails5 --no-quiet --run-all-checks

bundle-audit: #: Run bundle-audit vulnerability tests
	docker-compose run web bundle exec bundle-audit

lab: build server #: Run the lab

buildkite:
	docker run -e BUILDKITE_AGENT_TOKEN="${BUILDKITE_AGENT_TOKEN}" buildkite/agent
