_ROOT_DIR:=$(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
SHELL=/bin/bash

export RUBY_VERSION?=2.5
export RAILS_VERSION?=5.2.1
export CVE?=CVE-2019-5418
export RAILS_APP?=${_ROOT_DIR}/cves/${CVE}
export COMPOSE_DOCKER_CLI_BUILD=1
export DOCKER_BUILDKIT=1

ifeq (bundle,$(firstword $(MAKECMDGOALS)))
  BUNDLE_ARGS := $(wordlist 2,$(words $(MAKECMDGOALS)),$(MAKECMDGOALS))
  $(eval $(BUNDLE_ARGS):;@:)
endif

.PHONY:
	bundle

default: help

help: #: Show help topics
	@grep "#:" Makefile* | grep -v "@grep" | sort | sed "s/\([A-Za-z_ -]*\):.*#\(.*\)/$$(tput setaf 3)\1$$(tput sgr0)\2/g"

down: #: Stop and remove containers, networks, images, and volumes
	-docker-compose down

up: #: Create and start containers
	docker-compose up

clean: #: Clean up file system, containers, networks, images, and volumes
	down
	[ -d "${RAILS_APP}" ] && rm -rf ${RAILS_APP} || echo "setting up new CVE"
	cp -R template ${RAILS_APP}
	@sed -i "s/gem 'rails', 'N.N.N'/gem 'rails', '${RAILS_VERSION}'/" ${RAILS_APP}/Gemfile

build: clean #: Build the target image
	docker-compose run web rails new . --force --skip-git --skip-bundle --no-deps --database=postgresql
	@sed -i "s/gem 'rails', '~> ${RAILS_VERSION}'/gem 'rails', '${RAILS_VERSION}'/" ${RAILS_APP}/Gemfile
	docker-compose build \
	--build-arg RUBY_VERSION=${RUBY_VERSION} \
	--build-arg RAILS_VERSION=${RAILS_VERSION}

server: up #: Run the rails server

bundle: #: bundle exec ARGS
	docker-compose exec web bundle $(BUNDLE_ARGS)

shell: #: Run a bash shell
	docker-compose exec web bash

create: #: Run db:create
	docker-compose exec web bundle exec rake db:create

migrate: #: Run db:migrate
	docker-compose exec web bundle exec rake db:migrate

reset: #: Run db:reset
	docker-compose exec web bundle exec rake db:reset

console: #: Run the rails console
	docker-compose exec web bundle exec rails console

psql: #: Run a psql shell
	docker-compose exec postgres psql -U postgres app_development

brakeman:
	docker run correkthorse/rails:${RAILS_VERSION} bundle exec brakeman --rails5 --no-quiet --run-all-checks

bundle-audit:
	docker run correkthorse/rails:${RAILS_VERSION} bundle exec bundle-audit
